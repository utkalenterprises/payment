<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Credit Line Application</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- CSS for styling and animations -->
    <style>
        body {
            background: linear-gradient(to right, #f4f8fb, #c3e0e5);
            color: #333;
            font-family: 'Roboto', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 100%;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        input {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
        }
        button:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 24px;
            z-index: 9999;
            display: none; /* Hidden by default */
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Credit Line Application</h2>
        <form id="creditForm">
            <div class="form-group">
                <label for="shopName">Shop Name</label>
                <input type="text" id="shopName" required>
            </div>
            <div class="form-group">
                <label for="ownerName">Owner Name</label>
                <input type="text" id="ownerName" required>
            </div>
            <div class="form-group">
                <label for="mobileNumber">Mobile Number</label>
                <input type="text" id="mobileNumber" required>
            </div>
            <div class="form-group">
                <label for="shopAddress">Shop Address</label>
                <input type="text" id="shopAddress" required>
            </div>
            <div class="form-group">
                <label for="aadhaar">Aadhaar Number</label>
                <input type="text" id="aadhaar" required>
            </div>
            <div class="form-group">
                <label for="pan">PAN Number</label>
                <input type="text" id="pan" required>
            </div>
            <div class="form-group">
                <label for="shopPhoto">Shop Photo</label>
                <input type="file" id="shopPhoto" required>
            </div>
            <div class="form-group">
                <label for="ownerPhoto">Owner Photo</label>
                <input type="file" id="ownerPhoto" required>
            </div>
            <button type="button" onclick="submitForm()">Apply for Credit Line</button>
        </form>
    </div>

    <div id="loading" class="loading-overlay">
        <div>
            <p>Processing Your Data...</p>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCaiK6I2ft33OtoNISnJ1UAep6E7jBRfJ0",
            authDomain: "utkalb2b-web.firebaseapp.com",
            projectId: "utkalb2b-web",
            storageBucket: "utkalb2b-web.appspot.com",
            messagingSenderId: "974973982982",
            appId: "1:974973982982:web:90a779568f593817c5a687",
            measurementId: "G-QRX9527XPG"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const storage = firebase.storage();
        const db = firebase.firestore();

        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        async function submitForm() {
            showLoading();
            
            const shopName = document.getElementById('shopName').value;
            const ownerName = document.getElementById('ownerName').value;
            const mobileNumber = document.getElementById('mobileNumber').value;
            const shopAddress = document.getElementById('shopAddress').value;
            const aadhaar = document.getElementById('aadhaar').value;
            const pan = document.getElementById('pan').value;
            const shopPhoto = document.getElementById('shopPhoto').files[0];
            const ownerPhoto = document.getElementById('ownerPhoto').files[0];

            // Upload photos to Firebase Storage
            const shopPhotoRef = storage.ref().child('photos/' + shopPhoto.name);
            const ownerPhotoRef = storage.ref().child('photos/' + ownerPhoto.name);

            await shopPhotoRef.put(shopPhoto);
            await ownerPhotoRef.put(ownerPhoto);

            const shopPhotoURL = await shopPhotoRef.getDownloadURL();
            const ownerPhotoURL = await ownerPhotoRef.getDownloadURL();

            // Save data to Firestore
            db.collection('creditApplications').add({
                shopName: shopName,
                ownerName: ownerName,
                mobileNumber: mobileNumber,
                shopAddress: shopAddress,
                aadhaar: aadhaar,
                pan: pan,
                shopPhotoURL: shopPhotoURL,
                ownerPhotoURL: ownerPhotoURL,
                timestamp: new Date()
            }).then(() => {
                generatePDF(shopName, ownerName, mobileNumber, shopAddress, aadhaar, pan, shopPhotoURL, ownerPhotoURL);
                hideLoading();
                alert('Successfully applied for Credit Line!');
            }).catch((error) => {
                console.error('Error saving to Firestore: ', error);
                hideLoading();
            });
        }

        async function generatePDF(shopName, ownerName, mobileNumber, shopAddress, aadhaar, pan, shopPhotoURL, ownerPhotoURL) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Add header
            doc.setFontSize(18);
            doc.text("UTKAL ENTERPRISES", 20, 20);

            // Add shop and owner photos
            const shopPhoto = await fetch(shopPhotoURL).then(res => res.blob());
            const ownerPhoto = await fetch(ownerPhotoURL).then(res => res.blob());

            const shopPhotoData = await new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.readAsDataURL(shopPhoto);
            });

            const ownerPhotoData = await new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.readAsDataURL(ownerPhoto);
            });

            doc.addImage(shopPhotoData, 'JPEG', 20, 30, 50, 50);
            doc.addImage(ownerPhotoData, 'JPEG', 80, 30, 50, 50);

            // Add details
            doc.setFontSize(12);
            doc.text(`Shop Name: ${shopName}`, 20, 100);
            doc.text(`Owner Name: ${ownerName}`, 20, 110);
            doc.text(`Mobile Number: ${mobileNumber}`, 20, 120);
            doc.text(`Shop Address: ${shopAddress}`, 20, 130);
            doc.text(`Aadhaar: ${aadhaar}`, 20, 140);
            doc.text(`PAN: ${pan}`, 20, 150);

            // Add terms and conditions
            doc.text("Terms and Conditions", 20, 160);
            doc.setFontSize(10);
            doc.text("1. This is a credit line agreement with Utkal Enterprises.", 20, 170);
            // Add more terms as needed...

            // Upload PDF to Firebase Storage
            const pdfBlob = doc.output('blob');
            const pdfRef = storage.ref().child('agreements/' + `agreement_${Date.now()}.pdf`);
            await pdfRef.put(pdfBlob);

            const pdfURL = await pdfRef.getDownloadURL();
            console.log('PDF URL: ', pdfURL);
        }
    </script>
</body>
</html>
